<!DOCTYPE html>
<body lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录与注册页面</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .login-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 400px;
            position: relative;
        }

        input {
            display: block;
            width: 300px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
        }

        button {
            padding: 15px 30px;
            background-color: #007AFF;
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        h2 {
            font-size: 24px;
        }

        .register-section {
            display: none;
        }

        .register-toggle {
            display: inline-block;
            margin-left: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            left: 50%;
            transform: translateX(50%);
            border-radius: 5px;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .show-dropdown {
            display: block;
        }

        .button-group {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .login-part {
            display: block; /* 默认显示用户登录部分 */
        }

        .admin-login-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px; /* 减小内边距 */
            font-size: 14px; /* 减小字体大小 */
            border-radius: 5px; /* 减小边框半径 */
        }

        .admin-login-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .admin-login-modal .modal-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 400px;
        }
    </style>
</head>

<div class="login-container">
    <!-- 管理员登录按钮 -->
    <button class="admin-login-btn" onclick="showAdminLogin()">管理员登录</button>

    <!-- 用户登录部分 -->
    <div class="login-part" id="login-part">
        <h2>用户登录</h2>
        <input type="text" id="phone" placeholder="电话">
        <input type="password" id="password" placeholder="密码">
        <div id="captcha-container">
            <canvas id="captcha-canvas"></canvas>
            <input type="text" id="captcha-input" placeholder="请输入验证码">
        </div>
    </div>
    <div class="button-group" id="button-group">
        <button onclick="login()">登录</button>
        <button onclick="toggleDropdown()">注册</button>
    </div>
    <div class="dropdown-content" id="dropdown">
        <a href="#" onclick="showRegisterSection('customer')">消费者注册</a>
        <a href="#" onclick="showRegisterSection('merchant')">商家注册</a>
    </div>

    <!-- 消费者注册部分 -->
    <div class="register-section" id="customer-register">
        <h2>消费者注册</h2>
        <input type="text" id="customer-nickname" placeholder="昵称">
        <input type="password" id="customer-password" placeholder="密码">
        <input type="text" id="customer-name" placeholder="姓名">
        <input type="text" id="customer-gender" placeholder="性别">
        <input type="email" id="customer-email" placeholder="邮箱">
        <input type="tel" id="customer-phone" placeholder="电话">
        <button onclick="register('customer')">注册</button>
    </div>

    <!-- 商家注册部分 -->
    <div class="register-section" id="merchant-register">
        <h2>商家注册</h2>
        <input type="text" id="merchant-name" placeholder="姓名">
        <input type="password" id="merchant-password" placeholder="密码">
        <input type="email" id="merchant-email" placeholder="邮箱">
        <input type="tel" id="merchant-phone" placeholder="电话">
        <button onclick="register('merchant')">注册</button>
    </div>

    <!-- 管理员登录部分 -->
    <div class="admin-login-modal" id="admin-login-modal">
        <div class="modal-content">
            <h2>管理员登录</h2>
            <input type="text" id="admin-id" placeholder="管理员ID">
            <input type="password" id="admin-password" placeholder="密码">
            <button onclick="adminLogin()">登录</button>
        </div>
    </div>

    <script>
        //登录函数
        async function login() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const userInputCaptcha = document.getElementById('captcha-input').value;
            const storedCaptcha = localStorage.getItem('captcha');
            if (userInputCaptcha !== storedCaptcha) {
                alert('验证码错误，请重新输入');
                generateCaptcha(); // 重新生成验证码
                return;
            }
            try {
                const url = `http://127.0.0.1:5001/login?phone=${phone}&password=${password}`;
                const response = await fetch(url, {
                    method: 'GET'
                });
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status}`);
                    if (response.status === 401) {
                        alert("未授权，请检查电话和密码");
                    } else if (response.status === 403) {
                        alert("禁止访问");
                    } else if (response.status === 404) {
                        alert("未找到请求资源");
                    } else if (response.status === 500) {
                        alert("服务器内部错误，请稍后重试");
                    } else {
                        alert("请求失败，请检查网络或联系管理员");
                    }
                    return;
                }
                const data = await response.json();
                if (data.message === "登录成功.") {
                    if (data.role === 'customer') {
                        window.location.href = './h/customer.html';
                        localStorage.setItem('phonenumber', phone);
                    } else if (data.role === 'merchant') {
                        // 存储 phone 和 merchantname 到 localStorage
                        localStorage.setItem('phone', phone);
                        localStorage.setItem('merchantname', data.merchantname);
                        window.location.href = './h/merchant.html';
                    } else {
                        alert("未知的用户角色，请联系管理员");
                    }
                } else if (data.message === "无效的电话或密码.") {
                    alert("电话或密码错误，请重新输入");
                } else {
                    alert("登录出现未知错误，请稍后重试");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                if (error.message.includes("NetworkError")) {
                    alert("网络错误，请检查网络连接");
                } else if (error.message.includes("Failed to fetch")) {
                    alert("无法连接到服务器，请检查服务器是否运行");
                } else {
                    alert("登录出现错误，请稍后重试");
                }
            }
        }

        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let captchaText = '';
            for (let i = 0; i < 4; i++) {
                captchaText += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            localStorage.setItem('captcha', captchaText);

            // 设置画布背景颜色
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 设置文字样式
            ctx.font = '30px Arial';
            ctx.fillStyle = '#333';
            ctx.textBaseline = 'middle'; // 文字垂直居中

            // 绘制验证码文字
            for (let i = 0; i < captchaText.length; i++) {
                // 随机旋转角度
                const angle = (Math.random() - 0.5) * 20; // 生成-10到10度之间的随机角度
                ctx.translate(10 + i * 30 + 15, 30); // 将坐标原点移动到文字中心
                ctx.rotate(angle * Math.PI / 180); // 将角度转换为弧度并旋转
                ctx.fillText(captchaText[i], -15, 0); // 在旋转后的坐标系中绘制文字
                ctx.rotate(-angle * Math.PI / 180); // 恢复旋转前的状态
                ctx.translate(-(10 + i * 30 + 15), -30);
            }

            // 添加干扰线
            for (let i = 0; i < 10; i++) { // 增加干扰线数量
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.stroke();
            }

            // 添加干扰点
            for (let i = 0; i < 200; i++) { // 增加干扰点数量
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 1, 1);
            }

            // 添加波浪形干扰线
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            for (let i = 0; i < canvas.width; i++) {
                ctx.lineTo(i, canvas.height / 2 + Math.sin(i / 10) * 10);
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fill();
        }

        //此处是消费者和商家注册的下拉框
        function toggleDropdown() {
            document.getElementById('dropdown').classList.toggle('show-dropdown');
        }

        //显示注册页面的特定部分并隐藏另一个部分
        function showRegisterSection(type) {
            const registerSections = document.querySelectorAll('.register-section');
            registerSections.forEach(section => section.style.display = 'none');
            document.getElementById(type + '-register').style.display = 'block';
            document.getElementById('dropdown').classList.remove('show-dropdown');
            document.getElementById('login - part').style.display = 'none';
            document.getElementById('button-group').style.display = 'none'; // 隐藏登录和注册按钮
        }

        //注册
        async function register(type) {
            let formData = {};
            if (type === 'customer') {
                formData = {
                    password: document.getElementById('customer-password').value,
                    nickname: document.getElementById('customer-nickname').value,
                    name: document.getElementById('customer-name').value,
                    gender: document.getElementById('customer-gender').value,
                    email: document.getElementById('customer-email').value,
                    phone: document.getElementById('customer-phone').value,
                    role: 'Customer'
                };
            } else if (type === 'merchant') {
                formData = {
                    name: document.getElementById('merchant-name').value,
                    phone: document.getElementById('merchant-phone').value,
                    email: document.getElementById('merchant-email').value,
                    password: document.getElementById('merchant-password').value,
                    role: 'Merchant'
                };
            }
            try {
                const response = await fetch('http://127.0.0.1:5001/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status}`);
                    if (response.status === 400) {
                        alert("注册信息有误，请检查输入");
                    } else if (response.status === 500) {
                        alert("服务器内部错误，请稍后重试");
                    } else {
                        alert("注册失败，请检查网络或联系管理员");
                    }
                    return;
                }
                const data = await response.json();
                if (data.message === "Registered successfully.") {
                    alert("注册成功，请登录");
                    document.getElementById('customer-register').style.display = 'none';
                    document.getElementById('merchant-register').style.display = 'none';
                    document.getElementById('login - part').style.display = 'block';
                    document.getElementById('button-group').style.display = 'flex'; // 显示登录和注册按钮
                } else {
                    alert("注册出现未知错误，请稍后重试");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                if (error.message.includes("NetworkError")) {
                    alert("网络错误，请检查网络连接");
                } else if (error.message.includes("Failed to fetch")) {
                    alert("无法连接到服务器，请检查服务器是否运行");
                } else {
                    alert("注册出现错误，请稍后重试");
                }
            }
        }

        // 显示管理员登录界面
        function showAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'flex';
        }

        // 隐藏管理员登录界面
        function hideAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'none';
        }

        // 管理员登录
        function adminLogin() {
            const adminId = document.getElementById('admin-id').value;
            const adminPassword = document.getElementById('admin-password').value;
            if (adminId === 'nihao123' && adminPassword === '12345678') {
                window.location.href = './h/manager.html';
            } else {
                alert('管理员ID或密码错误');
                hideAdminLogin(); // 关闭登录界面
            }
        }

        window.addEventListener('load', function () {
            generateCaptcha();
        });

    </script>
</div>
</body>
</html>